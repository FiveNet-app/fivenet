<script lang="ts" setup>
import { z } from 'zod';
import { watchDebounced } from '@vueuse/shared';
import { format } from 'date-fns';
import DataErrorBlock from '~/components/partials/data/DataErrorBlock.vue';
import DataNoDataBlock from '~/components/partials/data/DataNoDataBlock.vue';
import DataPendingBlock from '~/components/partials/data/DataPendingBlock.vue';
import { useCompletorStore } from '~/store/completor';
import * as googleProtobufTimestamp from '~~/gen/ts/google/protobuf/timestamp';
import { Category } from '~~/gen/ts/resources/documents/category';
import { UserShort } from '~~/gen/ts/resources/users/users';
import { ListDocumentsRequest, ListDocumentsResponse } from '~~/gen/ts/services/docstore/docstore';
import DocumentListEntry from '~/components/documents/DocumentListEntry.vue';
import DatePicker from '~/components/partials/DatePicker.client.vue';
import Pagination from '~/components/partials/Pagination.vue';
import { useSettingsStore } from '~/store/settings';

const { $grpc } = useNuxtApp();

const { t } = useI18n();

const completorStore = useCompletorStore();

const settingsStore = useSettingsStore();
const { design } = storeToRefs(settingsStore);

type OpenClose = { id: number; label: string; closed?: boolean };

const openclose: OpenClose[] = [
    { id: 0, label: t('common.not_selected') },
    { id: 1, label: t('common.open', 2), closed: false },
    { id: 2, label: t('common.close', 2), closed: true },
];

const schema = z.object({
    documentIds: z.string().max(16).optional(),
    title: z.string().max(64),
    creators: z.custom<UserShort>().array().max(5),
    from: z.date().optional(),
    to: z.date().optional(),
    closed: z.boolean().optional(),
    category: z.custom<Category>().optional(),
});

type Schema = z.output<typeof schema>;

const query = ref<Schema>({
    title: '',
    creators: [],
});

const queryClosed = ref<OpenClose>(openclose[0]);

const usersLoading = ref(false);

const page = ref(1);
const offset = computed(() => (data.value?.pagination?.pageSize ? data.value?.pagination?.pageSize * (page.value - 1) : 0));

const { data, pending: loading, refresh, error } = useLazyAsyncData(`documents-${page.value}`, () => listDocuments());

async function creatorSearch(query: string): Promise<UserShort[]> {
    usersLoading.value = true;
    const users = await completorStore.completeCitizens({
        search: query,
    });
    usersLoading.value = false;
    return users;
}

async function listDocuments(): Promise<ListDocumentsResponse> {
    const req: ListDocumentsRequest = {
        pagination: {
            offset: offset.value,
        },
        orderBy: [],
        search: query.value.title ?? '',
        categoryIds: [],
        creatorIds: [],
        documentIds: [],
    };
    if (query.value.category) {
        req.categoryIds.push(query.value.category.id);
    }
    if (query.value.creators) {
        query.value.creators.forEach((c) => req.creatorIds.push(c.userId));
    }
    if (query.value.documentIds) {
        const id = query.value.documentIds.trim().replaceAll('-', '').replace(/\D/g, '');
        if (id.length > 0) {
            req.documentIds.push(id);
        }
    }
    if (query.value.from) {
        req.from = {
            timestamp: googleProtobufTimestamp.Timestamp.fromDate(query.value.from!),
        };
    }
    if (query.value.to) {
        req.to = {
            timestamp: googleProtobufTimestamp.Timestamp.fromDate(query.value.to!),
        };
    }
    if (query.value.closed !== undefined) {
        req.closed = query.value.closed;
    }

    try {
        const call = $grpc.getDocStoreClient().listDocuments(req);
        const { response } = await call;

        return response;
    } catch (e) {
        $grpc.handleError(e as RpcError);
        throw e;
    }
}

watch(offset, async () => refresh());
watchDebounced(query.value, async () => refresh(), { debounce: 200, maxWait: 1250 });

watch(queryClosed, () => (query.value.closed = queryClosed.value.closed));

const input = ref<{ input: HTMLInputElement }>();

defineShortcuts({
    '/': () => {
        input.value?.input?.focus();
    },
});
</script>

<template>
    <UDashboardToolbar>
        <template #default>
            <UForm :schema="schema" :state="query" class="w-full" @submit="refresh()">
                <UFormGroup name="title" :label="$t('common.search')">
                    <UInput
                        ref="input"
                        v-model="query.title"
                        type="text"
                        name="title"
                        :placeholder="$t('common.title')"
                        block
                        @focusin="focusTablet(true)"
                        @focusout="focusTablet(false)"
                        @keydown.esc="$event.target.blur()"
                    >
                        <template #trailing>
                            <UKbd value="/" />
                        </template>
                    </UInput>
                </UFormGroup>

                <UAccordion
                    class="mt-2"
                    color="white"
                    variant="soft"
                    size="sm"
                    :items="[{ label: $t('common.advanced_search'), slot: 'search' }]"
                >
                    <template #search>
                        <div class="flex flex-row flex-wrap gap-1">
                            <UFormGroup
                                class="flex-1"
                                name="documentIds"
                                :label="`${$t('common.document')} ${$t('common.id')}`"
                            >
                                <UInput
                                    v-model="query.documentIds"
                                    type="text"
                                    name="documentIds"
                                    placeholder="DOC-..."
                                    block
                                    @focusin="focusTablet(true)"
                                    @focusout="focusTablet(false)"
                                />
                            </UFormGroup>

                            <UFormGroup class="flex-1" name="category" :label="$t('common.category', 1)">
                                <UInputMenu
                                    v-model="query.category"
                                    nullable
                                    option-attribute="name"
                                    :search-attributes="['name']"
                                    block
                                    :search="completorStore.completeDocumentCategories"
                                    @focusin="focusTablet(true)"
                                    @focusout="focusTablet(false)"
                                >
                                    <template #option-empty="{ query: search }">
                                        <q>{{ search }}</q> {{ $t('common.query_not_found') }}
                                    </template>
                                    <template #empty> {{ $t('common.not_found', [$t('common.category', 2)]) }} </template>
                                </UInputMenu>
                            </UFormGroup>

                            <UFormGroup class="flex-1" name="creator" :label="$t('common.creator')">
                                <USelectMenu
                                    v-model="query.creators"
                                    multiple
                                    nullable
                                    block
                                    :searchable="creatorSearch"
                                    :search-attributes="['firstname', 'lastname']"
                                    :placeholder="$t('common.creator')"
                                    :searchable-placeholder="$t('common.search_field')"
                                    trailing
                                    by="userId"
                                >
                                    <template #option="{ option: user }">
                                        {{ `${user?.firstname} ${user?.lastname} (${user?.dateofbirth})` }}
                                    </template>
                                    <template #option-empty="{ query: search }">
                                        <q>{{ search }}</q> {{ $t('common.query_not_found') }}
                                    </template>
                                    <template #empty> {{ $t('common.not_found', [$t('common.creator', 2)]) }} </template>
                                </USelectMenu>
                            </UFormGroup>
                        </div>

                        <div class="flex flex-row flex-wrap gap-2">
                            <UFormGroup name="closed" :label="$t('common.close', 2)" class="flex-1">
                                <USelectMenu
                                    v-model="query.closed"
                                    :options="openclose"
                                    value-attribute="closed"
                                    :searchable-placeholder="$t('common.search_field')"
                                />
                            </UFormGroup>

                            <UFormGroup class="flex-1" name="from" :label="`${$t('common.time_range')} ${$t('common.from')}`">
                                <UPopover :popper="{ placement: 'bottom-start' }">
                                    <UButton
                                        variant="outline"
                                        color="gray"
                                        block
                                        icon="i-mdi-calendar-month"
                                        :label="query.from ? format(query.from, 'dd.MM.yyyy HH:mm') : 'dd.mm.yyyy HH:mm'"
                                    />

                                    <template #panel="{ close }">
                                        <DatePicker v-model="query.from" mode="dateTime" is24hr @close="close" />
                                    </template>
                                </UPopover>
                            </UFormGroup>
                            <UFormGroup class="flex-1" name="to" :label="`${$t('common.time_range')} ${$t('common.to')}`">
                                <UPopover :popper="{ placement: 'bottom-start' }">
                                    <UButton
                                        variant="outline"
                                        color="gray"
                                        block
                                        icon="i-mdi-calendar-month"
                                        :label="query.to ? format(query.to, 'dd.MM.yyyy HH:mm') : 'dd.mm.yyyy HH:mm'"
                                    />

                                    <template #panel="{ close }">
                                        <DatePicker v-model="query.to" mode="dateTime" is24hr @close="close" />
                                    </template>
                                </UPopover>
                            </UFormGroup>
                        </div>
                    </template>
                </UAccordion>
            </UForm>
        </template>
    </UDashboardToolbar>

    <DataPendingBlock v-if="loading" :message="$t('common.loading', [$t('common.document', 2)])" />
    <DataErrorBlock v-else-if="error" :title="$t('common.unable_to_load', [$t('common.document', 2)])" :retry="refresh" />
    <DataNoDataBlock v-else-if="data?.documents.length === 0" :type="$t('common.document', 2)" />

    <div v-else class="relative overflow-x-auto">
        <ul
            role="list"
            class="m-1 flex flex-col gap-1"
            :class="design.documents.listStyle === 'double' ? '2xl:grid 2xl:grid-cols-2' : ''"
        >
            <DocumentListEntry v-for="doc in data?.documents" :key="doc.id" :doc="doc" />
        </ul>
    </div>

    <Pagination v-model="page" :pagination="data?.pagination" />
</template>
