<script lang="ts" setup>
import { LCircle, LIcon, LMarker } from '@vue-leaflet/vue-leaflet';
import { type PointExpression } from 'leaflet';
import { markerIcons } from '~/components/livemap/helpers';
import MarkerMarkerPopup from '~/components/livemap/MarkerMarkerPopup.vue';
import type { MarkerMarker } from '~~/gen/ts/resources/livemap/livemap';

const props = withDefaults(
    defineProps<{
        marker: MarkerMarker;
        size?: number;
    }>(),
    {
        size: 20,
    },
);

defineEmits<{
    (e: 'selected'): void;
}>();

const iconAnchor = ref<PointExpression>([props.size / 2, props.size]);
const popupAnchor = ref<PointExpression>([0, (props.size / 2) * -1]);
</script>

<template>
    <LCircle
        v-if="marker.data?.data.oneofKind === 'circle'"
        :key="marker.info!.id"
        :lat-lng="[marker.info!.y, marker.info!.x]"
        :radius="marker.data?.data.circle.radius / 0.6931471805599453"
        :color="marker.info?.color ?? '#ffffff'"
        :fill-color="marker.info?.color ?? '#ffffff'"
        :fill-opacity="(marker.data.data.circle.opacity ?? 15) / 100"
    >
        <MarkerMarkerPopup :marker="marker" />
    </LCircle>

    <LMarker
        v-else-if="marker.data?.data.oneofKind === 'icon'"
        :lat-lng="[marker.info!.y, marker.info!.x]"
        :name="marker.info!.name"
        @click="$emit('selected')"
    >
        <LIcon :icon-size="[size, size]" :icon-anchor="iconAnchor" :popup-anchor="popupAnchor">
            <UIcon
                :name="
                    markerIcons.find((i) => marker.data?.data.oneofKind === 'icon' && i === marker.data?.data.icon.icon) ??
                    'i-mdi-map-marker-question'
                "
                class="h-auto w-full"
                :style="{ color: marker.info?.color ?? 'currentColor' }"
            />
        </LIcon>

        <MarkerMarkerPopup :marker="marker" />
    </LMarker>

    <LMarker v-else :lat-lng="[marker.info!.y, marker.info!.x]" :name="marker.info!.name" @click="$emit('selected')">
        <LIcon :icon-size="[size, size]" :icon-anchor="iconAnchor" :popup-anchor="popupAnchor">
            <UIcon name="i-mdi-map-marker-question" :fill="marker.info?.color ?? 'currentColor'" class="h-auto w-full" />
        </LIcon>

        <MarkerMarkerPopup :marker="marker" />
    </LMarker>
</template>
