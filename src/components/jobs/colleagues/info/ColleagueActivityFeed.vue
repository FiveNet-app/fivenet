<script lang="ts" setup>
import { z } from 'zod';
import DataErrorBlock from '~/components/partials/data/DataErrorBlock.vue';
import DataNoDataBlock from '~/components/partials/data/DataNoDataBlock.vue';
import DataPendingBlock from '~/components/partials/data/DataPendingBlock.vue';
import ColleagueActivityFeedEntry from '~/components/jobs/colleagues/info/ColleagueActivityFeedEntry.vue';
import type { ListColleagueActivityResponse } from '~~/gen/ts/services/jobs/jobs';
import { JobsUserActivityType, type Colleague } from '~~/gen/ts/resources/jobs/colleagues';
import { useCompletorStore } from '~/store/completor';
import Pagination from '~/components/partials/Pagination.vue';

const props = withDefaults(
    defineProps<{
        userId?: number;
        showTargetUser?: boolean;
    }>(),
    {
        userId: undefined,
        showTargetUser: false,
    },
);

const { $grpc } = useNuxtApp();

const completorStore = useCompletorStore();

const usersLoading = ref(false);

const typesAttrs = attrList('JobsService.ListColleagueActivity', 'Types').map((t) => t.toUpperCase());
const activityTypes = Object.keys(JobsUserActivityType)
    .filter((aType) => typesAttrs.includes(aType))
    .map((aType) => JobsUserActivityType[aType as keyof typeof JobsUserActivityType]);

const schema = z.object({
    colleagues: z.custom<Colleague>().array().max(10),
    types: z.nativeEnum(JobsUserActivityType).array().max(typesAttrs.length),
});

type Schema = z.output<typeof schema>;

const query = reactive<Schema>({
    colleagues: [],
    types: Object.keys(JobsUserActivityType)
        .filter((aType) => typesAttrs.includes(aType))
        .map((aType) => JobsUserActivityType[aType as keyof typeof JobsUserActivityType]),
});

const page = ref(1);
const offset = computed(() => (data.value?.pagination?.pageSize ? data.value?.pagination?.pageSize * (page.value - 1) : 0));

const selectedUsersIds = computed(() => (props.userId !== undefined ? [props.userId] : query.colleagues.map((u) => u.userId)));

const {
    data,
    pending: loading,
    refresh,
    error,
} = useLazyAsyncData(`jobs-colleague-${page.value}-${selectedUsersIds.value.join(',')}-${query.types.join(':')}`, () =>
    listColleagueActivity(selectedUsersIds.value, query.types),
);

async function listColleagueActivity(
    userIds: number[],
    activityTypes: JobsUserActivityType[],
): Promise<ListColleagueActivityResponse> {
    try {
        const call = $grpc.getJobsClient().listColleagueActivity({
            pagination: { offset: offset.value },
            userIds: userIds,
            activityTypes: activityTypes,
        });
        const { response } = await call;

        return response;
    } catch (e) {
        $grpc.handleError(e as RpcError);
        throw e;
    }
}

watch(offset, async () => refresh());

const accessAttrs = attrList('JobsService.GetColleague', 'Access');
const colleagueSearchAttrs = ['own', 'lower_rank', 'same_rank', 'any'];

watch(props, async () => refresh());
watchDebounced(query, async () => refresh(), {
    debounce: 500,
    maxWait: 1250,
});
</script>

<template>
    <UDashboardToolbar v-if="userId === undefined || accessAttrs.some((a) => colleagueSearchAttrs.includes(a))">
        <UForm :schema="schema" :state="query" class="flex w-full gap-2" @submit="refresh()">
            <UFormGroup v-if="userId === undefined" name="colleagues" :label="$t('common.search')" class="flex-1">
                <USelectMenu
                    v-model="query.colleagues"
                    multiple
                    :searchable="
                        async (query: string) => {
                            usersLoading = true;
                            const colleagues = await completorStore.listColleagues({
                                search: query,
                            });
                            usersLoading = false;
                            return colleagues;
                        }
                    "
                    :search-attributes="['firstname', 'lastname']"
                    block
                    :placeholder="$t('common.colleague', 2)"
                    trailing
                    by="userId"
                    :searchable-placeholder="$t('common.search_field')"
                    @focusin="focusTablet(true)"
                    @focusout="focusTablet(false)"
                >
                    <template #label>
                        <template v-if="query.colleagues.length">
                            {{ usersToLabel(query.colleagues) }}
                        </template>
                    </template>
                    <template #option="{ option: user }">
                        {{ `${user?.firstname} ${user?.lastname} (${user?.dateofbirth})` }}
                    </template>
                    <template #option-empty="{ query: search }">
                        <q>{{ search }}</q> {{ $t('common.query_not_found') }}
                    </template>
                    <template #empty> {{ $t('common.not_found', [$t('common.creator', 2)]) }} </template>
                </USelectMenu>
            </UFormGroup>
            <div v-else class="flex-1" />

            <UFormGroup
                v-if="accessAttrs.some((a) => colleagueSearchAttrs.includes(a))"
                name="types"
                :label="$t('common.type', 2)"
            >
                <USelectMenu
                    v-model="query.types"
                    class="w-48 min-w-40 flex-initial"
                    multiple
                    block
                    trailing
                    option-attribute="aType"
                    :options="activityTypes.map((aType) => ({ aType: aType }))"
                    value-attribute="aType"
                    :searchable-placeholder="$t('common.type', 2)"
                >
                    <template #option="{ option }">
                        {{ $t(`enums.jobs.JobsUserActivityType.${JobsUserActivityType[option.aType]}`) }}
                    </template>
                    <template #option-empty="{ query: search }">
                        <q>{{ search }}</q> {{ $t('common.query_not_found') }}
                    </template>
                    <template #empty> {{ $t('common.not_found', [$t('common.type', 2)]) }} </template>
                </USelectMenu>
            </UFormGroup>
        </UForm>
    </UDashboardToolbar>

    <DataPendingBlock
        v-if="loading"
        :message="$t('common.loading', [`${$t('common.colleague', 1)} ${$t('common.activity')}`])"
    />
    <DataErrorBlock
        v-else-if="error"
        :title="$t('common.not_found', [`${$t('common.colleague', 1)} ${$t('common.activity')}`])"
        :retry="refresh"
    />
    <DataNoDataBlock
        v-else-if="data?.activity.length === 0"
        icon="i-mdi-bulletin-board"
        :type="`${$t('common.colleague', 1)} ${$t('common.activity')}`"
    />

    <div v-else class="relative overflow-x-auto">
        <ul role="list" class="divide-y divide-gray-100 dark:divide-gray-800">
            <li v-for="activity in data?.activity" :key="activity.id" class="px-2 py-4">
                <ColleagueActivityFeedEntry :activity="activity" :show-target-user="showTargetUser" />
            </li>
        </ul>
    </div>

    <Pagination v-model="page" :pagination="data?.pagination" :loading="loading" :refresh="refresh" />
</template>
