package main

import (
	"text/template"

	pgsgo "github.com/lyft/protoc-gen-star/v2/lang/go"

	pgs "github.com/lyft/protoc-gen-star/v2"
)

// JSEnumHelperPlugin
type JSEnumHelperModule struct {
	*pgs.ModuleBase
	ctx pgsgo.Context
	tpl *template.Template
}

// JSEnumHelper returns an initialized JSEnumHelperPlugin
func JSEnumHelper() *JSEnumHelperModule { return &JSEnumHelperModule{ModuleBase: &pgs.ModuleBase{}} }

func (p *JSEnumHelperModule) InitContext(c pgs.BuildContext) {
	p.ModuleBase.InitContext(c)
	p.ctx = pgsgo.InitContext(c.Parameters())

	tpl := template.New("jsEnumHelper").Funcs(map[string]interface{}{
		"package": p.ctx.PackageName,
		"name":    p.ctx.Name,
	})

	p.tpl = template.Must(tpl.Parse(jsEnumHelperTpl))
}

// Name satisfies the generator.Plugin interface.
func (p *JSEnumHelperModule) Name() string { return "jsEnumHelper" }

func (p *JSEnumHelperModule) Execute(targets map[string]pgs.File, pkgs map[string]pgs.Package) []pgs.Artifact {
	for _, t := range targets {
		p.generate(t)
	}

	return p.Artifacts()
}

func (p *JSEnumHelperModule) generate(f pgs.File) {
	if len(f.Enums()) == 0 {
		return
	}

	name := p.ctx.OutputPath(f).SetExt("_enums.ts")
	p.AddGeneratorTemplateFile(name.String(), p.tpl, f)
}

const jsEnumHelperTpl = `// Code generated by protoc-gen-customizerweb. DO NOT EDIT.
// source: {{ .File.InputPath }}

import * as enums from './{{ name .File }}_pb';
{{ range .Enums }}
{{ $enum := . }}
// {{ .Descriptor.Name }}
export class {{ .Descriptor.Name }}_Util {
    public static toEnumKey(input: enums.{{ .Descriptor.Name }}): string | undefined {
        const index = Object.values(enums.{{ .Descriptor.Name }}).indexOf(input);
        if (index <= -1) {
            return "N/A";
        }
        return Object.keys(enums.{{ .Descriptor.Name }})[index];
    }

    public static fromInt(input: Number): enums.{{ .Descriptor.Name }} {
        switch (input) {
            {{- range $k, $val := .Values }}
            case {{ $val.Value }}:
                return enums.{{ $enum.Descriptor.Name }}.{{ $val.Descriptor.Name }};
            {{ end -}}
        }
        {{- range $k, $val := .Values }}
        return enums.{{ $enum.Descriptor.Name }}.{{ $val.Descriptor.Name }};
        {{- break }}
        {{- end }}
    }

    public static fromString(input: String): enums.{{ .Descriptor.Name }} {
        switch (input) {
            {{- range $k, $val := .Values }}
            case '{{ $val.Descriptor.Name }}':
                return enums.{{ $enum.Descriptor.Name }}.{{ $val.Descriptor.Name }};
            {{ end -}}
        }
        {{- range $k, $val := .Values }}
        return enums.{{ $enum.Descriptor.Name }}.{{ $val.Descriptor.Name }};
        {{- break }}
        {{- end }}
    }
}
{{- end }}
`

/*

{{ range $val := .Value }}
            case "{{ $val.Descriptor.Name }}":
                return enums.{{ .Descriptor.Name }}.{{ $val.Descriptor.Name }}
            {{ .Values }}
            {{ end }}

*/
