syntax = "proto3";

package services.docstore;
option go_package = "github.com/galexrt/fivenet/gen/go/proto/services/docstore;docstore";

import "resources/common/database/database.proto";
import "resources/documents/category.proto";
import "resources/documents/documents.proto";
import "resources/documents/templates.proto";
import "validate/validate.proto";

// Templates ==================================================================
message ListTemplatesRequest {}

message ListTemplatesResponse {
  repeated resources.documents.TemplateShort templates = 1;
}

message GetTemplateRequest {
  uint64 template_id = 1;
  string data = 2 [(validate.rules).string.max_bytes = 10240];
  optional bool render = 3;
}

message GetTemplateResponse {
  resources.documents.Template template = 1;
  bool rendered = 2;
}

message CreateTemplateRequest {
  resources.documents.Template template = 1 [(validate.rules).message.required = true];
}

message CreateTemplateResponse {
  uint64 id = 1;
}

message UpdateTemplateRequest {
  resources.documents.Template template = 1 [(validate.rules).message.required = true];
}

message UpdateTemplateResponse {
  uint64 id = 1;
}

message DeleteTemplateRequest {
  uint64 id = 1;
}

message DeleteTemplateResponse {}

// Documents ==================================================================
message ListDocumentsRequest {
  resources.common.database.PaginationRequest pagination = 1 [(validate.rules).message.required = true];
  repeated resources.common.database.OrderBy orderBy = 2  [(validate.rules).repeated.max_items = 3];
  // Search param
  string search = 3;
  repeated uint64 category_ids = 4;
}

message ListDocumentsResponse {
  resources.common.database.PaginationResponse pagination = 1 [(validate.rules).message.required = true];
  repeated resources.documents.Document documents = 2;
}

message GetDocumentRequest {
  uint64 document_id = 1;
}

message GetDocumentResponse {
  resources.documents.Document document = 1;
  resources.documents.DocumentAccess access = 2;
}

message GetDocumentReferencesRequest {
  uint64 document_id = 1;
}

message GetDocumentReferencesResponse {
  repeated resources.documents.DocumentReference references = 1; // @gotags: alias:"reference"
}

message GetDocumentRelationsRequest {
  uint64 document_id = 1;
}

message GetDocumentRelationsResponse {
  repeated resources.documents.DocumentRelation relations = 1; // @gotags: alias:"relation"
}

message AddDocumentReferenceRequest {
  resources.documents.DocumentReference reference = 1 [(validate.rules).message.required = true];
}

message AddDocumentReferenceResponse {
  uint64 id = 1;
}

message RemoveDocumentReferenceRequest {
  uint64 id = 1;
}

message RemoveDocumentReferenceResponse {}

message AddDocumentRelationRequest {
  resources.documents.DocumentRelation relation = 1 [(validate.rules).message.required = true];
}

message AddDocumentRelationResponse {
  uint64 id = 1;
}

message RemoveDocumentRelationRequest {
  uint64 id = 1;
}

message RemoveDocumentRelationResponse {}

// Comments ===============================================================
message GetDocumentCommentsRequest {
  resources.common.database.PaginationRequest pagination = 1 [(validate.rules).message.required = true];
  uint64 document_id = 2;
}

message GetDocumentCommentsResponse {
  resources.common.database.PaginationResponse pagination = 1;
  repeated resources.documents.DocumentComment comments = 2;
}

message PostDocumentCommentRequest {
  resources.documents.DocumentComment comment = 1;
}

message PostDocumentCommentResponse {
  uint64 id = 1;
}

message EditDocumentCommentRequest {
  resources.documents.DocumentComment comment = 1;
}

message EditDocumentCommentResponse {}

message DeleteDocumentCommentRequest {
  uint64 comment_id = 1;
}

message DeleteDocumentCommentResponse {}

message CreateDocumentRequest {
  optional uint64 category_id = 1; // @gotags: alias:"category_id"
  string title = 2 [(validate.rules).string = {min_len: 3, max_bytes: 21845}]; // @gotags: alias:"title"
  string content = 3 [(validate.rules).string = {min_len: 20, max_bytes: 65535}]; // @gotags: alias:"content"
  resources.documents.DOC_CONTENT_TYPE content_type = 4 [(validate.rules).enum.defined_only = true]; // @gotags: alias:"content_type"
  optional string data = 5; // @gotags: alias:"data"
  string state = 6 [(validate.rules).string.max_len = 24]; // @gotags: alias:"state"
  bool closed = 7; // @gotags: alias:"closed"
  bool public = 8; // @gotags: alias:"public"

  optional resources.documents.DocumentAccess access = 9;
}

message CreateDocumentResponse {
  uint64 document_id = 1; // @gotags: alias:"id"
}

message UpdateDocumentRequest {
  uint64 document_id = 1; // @gotags: alias:"id"
  uint64 category_id = 2; // @gotags: alias:"category_id"
  string title = 3 [(validate.rules).string = {min_len: 3, max_bytes: 21845}]; // @gotags: alias:"title"
  string content = 4 [(validate.rules).string = {min_len: 20, max_bytes: 65535}]; // @gotags: alias:"content"
  resources.documents.DOC_CONTENT_TYPE content_type = 5 [(validate.rules).enum.defined_only = true]; // @gotags: alias:"content_type"
  string data = 6; // @gotags: alias:"data"
  string state = 7 [(validate.rules).string.max_len = 24]; // @gotags: alias:"state"
  bool closed = 8; // @gotags: alias:"closed"
  bool public = 9; // @gotags: alias:"public"

  optional resources.documents.DocumentAccess access = 10;
}

message UpdateDocumentResponse {
  uint64 document_id = 1; // @gotags: alias:"id"
}

message DeleteDocumentRequest {
  uint64 document_id = 1; // @gotags: alias:"id"
}

message DeleteDocumentResponse {}

// Access =================================================================
message GetDocumentAccessRequest {
  uint64 document_id = 1;
}

message GetDocumentAccessResponse {
  resources.documents.DocumentAccess access = 1 [(validate.rules).message.required = true];
}

enum ACCESS_LEVEL_UPDATE_MODE {
  UPDATE = 0;
  DELETE = 1;
  CLEAR = 2;
}

message SetDocumentAccessRequest {
  uint64 document_id = 1;
  ACCESS_LEVEL_UPDATE_MODE mode = 2 [(validate.rules).enum.defined_only = true];
  resources.documents.DocumentAccess access = 3;
}

message SetDocumentAccessResponse {}

message ListUserDocumentsRequest {
  resources.common.database.PaginationRequest pagination = 1 [(validate.rules).message.required = true];
  int32 user_id = 2 [(validate.rules).int32.gt = 0];
  repeated resources.documents.DOC_RELATION relations = 3 [(validate.rules).repeated.max_items = 3];
}

message ListUserDocumentsResponse {
  resources.common.database.PaginationResponse pagination = 1;
  repeated resources.documents.DocumentRelation relations = 2;
}

// Categories
message ListDocumentCategoriesRequest {}

message ListDocumentCategoriesResponse {
  repeated resources.documents.DocumentCategory category = 1;
}

message CreateDocumentCategoryRequest {
  resources.documents.DocumentCategory category = 1 [(validate.rules).message.required = true];
}

message CreateDocumentCategoryResponse {
  uint64 id = 1;
}

message UpdateDocumentCategoryRequest {
  resources.documents.DocumentCategory category = 1 [(validate.rules).message.required = true];
}

message UpdateDocumentCategoryResponse {}

message DeleteDocumentCategoryRequest {
  repeated uint64 ids = 1;
}

message DeleteDocumentCategoryResponse {}

service DocStoreService {
  // @perm
  rpc ListTemplates(ListTemplatesRequest) returns (ListTemplatesResponse);
  // @perm: Name=ListTemplates
  rpc GetTemplate(GetTemplateRequest) returns (GetTemplateResponse);
  // @perm
  rpc CreateTemplate(CreateTemplateRequest) returns (CreateTemplateResponse);
  // @perm: Name=CreateTemplate
  rpc UpdateTemplate(UpdateTemplateRequest) returns (UpdateTemplateResponse);
  // @perm
  rpc DeleteTemplate(DeleteTemplateRequest) returns (DeleteTemplateResponse);

  // @perm
  rpc ListDocuments(ListDocumentsRequest) returns (ListDocumentsResponse);
  // @perm
  rpc GetDocument(GetDocumentRequest) returns (GetDocumentResponse);
  // @perm
  rpc CreateDocument(CreateDocumentRequest) returns (CreateDocumentResponse);
  // @perm
  rpc UpdateDocument(UpdateDocumentRequest) returns (UpdateDocumentResponse);
  // @perm
  rpc DeleteDocument(DeleteDocumentRequest) returns (DeleteDocumentResponse);

  // @perm: Name=GetDocument
  rpc GetDocumentReferences(GetDocumentReferencesRequest) returns (GetDocumentReferencesResponse);
  // @perm: Name=GetDocument
  rpc GetDocumentRelations(GetDocumentRelationsRequest) returns (GetDocumentRelationsResponse);
  // @perm
  rpc AddDocumentReference(AddDocumentReferenceRequest) returns (AddDocumentReferenceResponse);
  // @perm: Name=AddDocumentReference
  rpc RemoveDocumentReference(RemoveDocumentReferenceRequest) returns (RemoveDocumentReferenceResponse);
  // @perm
  rpc AddDocumentRelation(AddDocumentRelationRequest) returns (AddDocumentRelationResponse);
  // @perm: Name=AddDocumentRelation
  rpc RemoveDocumentRelation(RemoveDocumentRelationRequest) returns (RemoveDocumentRelationResponse);

  // @perm
  rpc GetDocumentComments(GetDocumentCommentsRequest) returns (GetDocumentCommentsResponse);
  // @perm
  rpc PostDocumentComment(PostDocumentCommentRequest) returns (PostDocumentCommentResponse);
  // @perm: Name=PostDocumentComment
  rpc EditDocumentComment(EditDocumentCommentRequest) returns (EditDocumentCommentResponse);
  // @perm
  rpc DeleteDocumentComment(DeleteDocumentCommentRequest) returns (DeleteDocumentCommentResponse);

  // @perm
  rpc GetDocumentAccess(GetDocumentAccessRequest) returns (GetDocumentAccessResponse);
  // @perm
  rpc SetDocumentAccess(SetDocumentAccessRequest) returns (SetDocumentAccessResponse);

  // @perm
  rpc ListUserDocuments(ListUserDocumentsRequest) returns (ListUserDocumentsResponse);

  // @perm
  rpc ListDocumentCategories(ListDocumentCategoriesRequest) returns (ListDocumentCategoriesResponse);
  // @perm
  rpc CreateDocumentCategory(CreateDocumentCategoryRequest) returns (CreateDocumentCategoryResponse);
  // @perm: Name=CreateDocumentCategory
  rpc UpdateDocumentCategory(UpdateDocumentCategoryRequest) returns (UpdateDocumentCategoryResponse);
  // @perm
  rpc DeleteDocumentCategory(DeleteDocumentCategoryRequest) returns (DeleteDocumentCategoryResponse);
}
