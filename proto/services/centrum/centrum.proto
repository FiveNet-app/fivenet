syntax = "proto3";

package services.centrum;
option go_package = "github.com/galexrt/fivenet/gen/go/proto/services/centrum;centrum";

import "resources/common/database/database.proto";
import "resources/dispatch/dispatch.proto";
import "resources/dispatch/units.proto";
import "validate/validate.proto";

// Common

message ListActivityRequest {
  resources.common.database.PaginationRequest pagination = 1 [(validate.rules).message.required = true];
  uint64 id = 2;
}

// Unit Management

message ListUnitsRequest {
  repeated resources.dispatch.UNIT_STATUS status = 1 [(validate.rules).repeated.items.enum.defined_only = true];
}

message ListUnitsResponse {
  repeated resources.dispatch.Unit units = 1;
}

message CreateOrUpdateUnitRequest {
  resources.dispatch.Unit unit = 1 [(validate.rules).message.required = true];
}

message CreateOrUpdateUnitResponse {
  resources.dispatch.Unit unit = 1;
}

message DeleteUnitRequest {
  uint64 unit_id = 1;
}

message DeleteUnitResponse {}

message UpdateUnitStatusRequest {
  uint64 unit_id = 1;
  resources.dispatch.UNIT_STATUS status = 2 [(validate.rules).enum.defined_only = true];
  optional string reason = 3;
  optional string code = 4;
}

message UpdateUnitStatusResponse {}

message AssignUnitRequest {
  uint64 unit_id = 1;
  optional bool self_add = 2;
  optional bool self_remove = 3;
  repeated int32 to_add = 4;
  repeated int32 to_remove = 5;
}

message AssignUnitResponse {}

message ListUnitActivityResponse {
  resources.common.database.PaginationResponse pagination = 1;
  repeated resources.dispatch.UnitStatus activity = 2;
}

message UnitChanges {
  repeated UnitChange changes = 1;
}

message UnitChange {
  repeated resources.dispatch.UnitAssignment added = 1;
  repeated resources.dispatch.UnitAssignment removed = 2;
}

// Dispatch Management

message ListDispatchesRequest {
  repeated resources.dispatch.DISPATCH_STATUS status = 1 [(validate.rules).repeated.items.enum.defined_only = true];
}

message ListDispatchesResponse {
  repeated resources.dispatch.Dispatch dispatches = 1;
}

message CreateDispatchRequest {
  resources.dispatch.Dispatch dispatch = 1 [(validate.rules).message.required = true];
}

message CreateDispatchResponse {
  resources.dispatch.Dispatch dispatch = 1;
}

message UpdateDispatchRequest {
  resources.dispatch.Dispatch dispatch = 1 [(validate.rules).message.required = true];
}

message UpdateDispatchResponse {
  resources.dispatch.Dispatch dispatch = 1;
}

message UpdateDispatchStatusRequest {

}

message UpdateDispatchStatusResponse {

}

message AssignDispatchRequest {

}

message AssignDispatchResponse {

}

message ListDispatchActivityResponse {
  resources.common.database.PaginationResponse pagination = 1;
  repeated resources.dispatch.DispatchStatus activity = 2;
}

enum TAKE_DISPATCH_RESP {
  TIMEOUT = 0;
  ACCEPTED = 1;
  DECLINED = 2;
}

message TakeDispatchRequest {
  uint64 dispatch_id = 1;
  TAKE_DISPATCH_RESP resp = 2 [(validate.rules).enum.defined_only = true];
  optional string reason = 3 [(validate.rules).string.max_len = 255];
}

message TakeDispatchResponse {
  resources.dispatch.Dispatch dispatch = 1;
}

message DispatchChanges {
  repeated DispatchChange changes = 1;
}

message DispatchChange {
  uint64 id = 1;
}

message CentrumStreamRequest {}

message CentrumStreamResponse {
  oneof change {
    UnitChanges units_change = 1;
    resources.dispatch.UnitStatus unit_status = 2;

    DispatchChanges dispatches_change = 3;
    resources.dispatch.DispatchStatus dispatch_status = 4;
    // When a dispatch is assigned to a unit
    resources.dispatch.Dispatch dispatch_assigned = 5;
  }
}

service CentrumService {
  // @perm
  rpc ListUnits(ListUnitsRequest) returns (ListUnitsResponse);
  // @perm
  rpc CreateOrUpdateUnit(CreateOrUpdateUnitRequest) returns (CreateOrUpdateUnitResponse);
  // @perm
  rpc DeleteUnit(DeleteUnitRequest) returns (DeleteUnitResponse);
  // @perm
  rpc UpdateUnitStatus(UpdateUnitStatusRequest) returns (UpdateUnitStatusResponse);
  // @perm: Attrs=Access/StringList:[]string{"Own", "Lower_Rank", "Same_Rank"}ยง[]string{"Own"}
  rpc AssignUnit(AssignUnitRequest) returns (AssignUnitResponse);
  // @perm: Name=ListUnits
  rpc ListUnitActivity(ListActivityRequest) returns (ListUnitActivityResponse);

  // @perm
  rpc ListDispatches(ListDispatchesRequest) returns (ListDispatchesResponse);
  // @perm
  rpc CreateDispatch(CreateDispatchRequest) returns (CreateDispatchResponse);
  // @perm
  rpc UpdateDispatch(UpdateDispatchRequest) returns (UpdateDispatchResponse);
  // @perm
  rpc TakeDispatch(TakeDispatchRequest) returns (TakeDispatchResponse);
  // @perm: Name=TakeDispatch
  rpc UpdateDispatchStatus(UpdateDispatchStatusRequest) returns (UpdateDispatchStatusResponse);
  // @perm
  rpc AssignDispatch(AssignDispatchRequest) returns (AssignDispatchResponse);
  // @perm: Name=Stream
  rpc ListDispatchActivity(ListActivityRequest) returns (ListDispatchActivityResponse);

  // @perm
  rpc Stream(CentrumStreamRequest) returns (stream CentrumStreamResponse);
}
