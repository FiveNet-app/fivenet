# Default values for fivenet.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

podAnnotations: {}

podSecurityContext: {}
  # fsGroup: 2000

securityContext: {}
  # capabilities:
  #   drop:
  #   - ALL
  # readOnlyRootFilesystem: true
  # runAsNonRoot: true
  # runAsUser: 1000

service:
  type: ClusterIP

nodeSelector: {}

tolerations: []

affinity: {}

ingress:
  enabled: true
  className: "nginx"
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"
    #nginx.ingress.kubernetes.io/ssl-redirect: "true"
    #nginx.ingress.kubernetes.io/server-snippet: |
    #  client_body_timeout 3600s;
  hosts:
    - host: chart-example.local
      paths:
        - path: /grpc
          pathType: Prefix
          service: envoy
          servicePort: grpc
        - path: /
          pathType: Prefix
  tls: []
  #  - secretName: chart-example-tls
  #    hosts:
  #      - chart-example.local

fivenet:
  replicaCount: 1
  image:
    repository: docker.io/galexrt/fivenet
    pullPolicy: IfNotPresent
    # Overrides the image tag whose default is the chart appVersion.
    tag: ""
  resources: {}
    # We usually recommend not to specify default resources and to leave this as a conscious
    # choice for the user. This also increases chances charts run on environments with little
    # resources, such as Minikube. If you do want to specify resources, uncomment the following
    # lines, adjust them as necessary, and remove the curly braces after 'resources:'.
    # limits:
    #   cpu: 100m
    #   memory: 128Mi
    # requests:
    #   cpu: 100m
    #   memory: 128Mi
  livenessProbe:
    httpGet:
      path: /readiness
      port: http
    initialDelaySeconds: 15
    periodSeconds: 10
  readinessProbe:
    httpGet:
      path: /readiness
      port: http
    initialDelaySeconds: 10
    periodSeconds: 7
  additionalEnv: []
  serviceMonitor:
    # -- Specifies whether a prometheus-operator ServiceMonitor should be created
    enabled: false
    # -- Additional Labels for the ServiceMonitor object
    additionalLabels: {}
    #namespace: "monitoring"
    namespaceSelector:
    # Default: scrape .Release.Namespace only
    # To scrape all, use the following:
    #  matchNames:
    #    - monitoring
    #   any: true
    # -- (duration) Interval at which metrics should be scraped
    scrapeInterval: 30s
    # honorLabels: true
  # -- FiveNet config
  config:
    logLevel: "DEBUG"
    # debug or release
    mode: "release"
    sentry:
      environment: "live"
      # Your Sentry or Glitchtip SDN
      clientDSN: ""
      serverDSN: ""
    tracing:
      enabled: false
      # Jaeger Tracing endpoint (should have the right API path in the URL `/api/traces`)
      url: ""
      environment: "live"
    http:
      listen: ":8080"
      sessions:
        cookieSecret: "YOUR_COOKIE_SECRET"
        domain: "chart-example.local"
    grpc:
      listen: ":9090"
    database:
      # refer to https://github.com/go-sql-driver/mysql#dsn-data-source-name for details
      dsn: "YOUR_USERNAME:YOUR_PASSWORD@tcp(localhost:3306)/fivem?collation=utf8mb4_unicode_ci&parseTime=True&loc=Local"
      dbName: fivem
      maxOpenConns: 32
      maxIdleConns: 5
      connMaxIdleTime: 15m
      connMaxLifetime: 60m
    nats:
      # If you change the NATS username or password, below `nats:` config section
      url: "nats://fivenet:fivenet@localhost:4222"
      workerCount: 5
    jwt:
      secret: "YOUR_JWT_SECRET"
    oauth2:
      providers: []
    cache:
      refreshTime: 2m
    game:
      superuserGroups:
        - projektleiter
        - teamleitung
      unemployedJob:
        name: "unemployed"
        grade: 1
      publicJobs:
        - ambulance
        - doj
        - fib
        - police
      livemap:
        refreshTime: 3s850ms
        jobs:
          - ambulance
          - doj
          - fib
          - police
      defaultPermissions:
        - category: AuthService
          name: ChooseCharacter
        - category: CompletorService
          name: CompleteJobs
        - category: DocStoreService
          name: ListDocuments
        - category: DocStoreService
          name: GetDocument
        - category: DocStoreService
          name: GetComments
        - category: DocStoreService
          name: PostComment

envoy:
  replicaCount: 1
  image:
    repository: docker.io/envoyproxy/envoy
    pullPolicy: IfNotPresent
    # Overrides the image tag whose default is the chart appVersion.
    tag: "v1.26.2"
  resources: {}
    # We usually recommend not to specify default resources and to leave this as a conscious
    # choice for the user. This also increases chances charts run on environments with little
    # resources, such as Minikube. If you do want to specify resources, uncomment the following
    # lines, adjust them as necessary, and remove the curly braces after 'resources:'.
    # limits:
    #   cpu: 100m
    #   memory: 128Mi
    # requests:
    #   cpu: 100m
    #   memory: 128Mi
  livenessProbe:
    httpGet:
      path: /ready
      port: admin
  readinessProbe:
    httpGet:
      path: /ready
      port: admin
  # -- Envoy config
  config:
    admin:
      access_log_path: /tmp/admin_access.log
      address:
        socket_address: { address: 0.0.0.0, port_value: 9901 }
    layered_runtime:
      layers:
        - name: static_layer_0
          static_layer:
            envoy:
              resource_limits:
                listener:
                  example_listener_name:
                    connection_limit: 10000
            overload:
              global_downstream_max_connections: 50000
    static_resources:
      listeners:
        - name: listener_0
          address:
            socket_address: { address: 0.0.0.0, port_value: 8181, ipv4_compat: true }
          filter_chains:
            - filters:
              - name: envoy.filters.network.http_connection_manager
                typed_config:
                  "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                  codec_type: auto
                  stat_prefix: ingress_http
                  # Should be set when behind an proxy/Ingress
                  use_remote_address: true
                  common_http_protocol_options:
                    idle_timeout: 3600s  # 1 hour
                    headers_with_underscores_action: REJECT_REQUEST
                  http2_protocol_options:
                    max_concurrent_streams: 200
                    initial_stream_window_size: 65536  # 64 KiB
                    initial_connection_window_size: 1048576  # 1 MiB
                  stream_idle_timeout: 0s  # disabled for long-lived and streaming requests
                  request_timeout: 0s  # disabled for long-lived and streaming requests
                  route_config:
                    name: local_route
                    virtual_hosts:
                      - name: local_service
                        domains: ["*"]
                        routes:
                          - match:
                              prefix: "/grpc/"
                            route:
                              prefix_rewrite: "/"
                              cluster: fivenet_service
                              timeout: 0s
                              idle_timeout: 0s
                              max_stream_duration:
                                grpc_timeout_header_max: 35s
                        cors:
                          allow_origin_string_match:
                            - safe_regex:
                                google_re2: {}
                                regex: \*
                          allow_methods: GET, PUT, DELETE, POST, OPTIONS
                          allow_headers: keep-alive,user-agent,cache-control,content-type,content-transfer-encoding,x-accept-content-transfer-encoding,x-accept-response-streaming,x-user-agent,x-grpc-web,grpc-timeout,authorization
                          max_age: "1728000"
                          expose_headers: grpc-status,grpc-message
                  http_filters:
                    - name: envoy.filters.http.grpc_web
                      typed_config:
                        "@type": type.googleapis.com/envoy.extensions.filters.http.grpc_web.v3.GrpcWeb
                    - name: envoy.filters.http.cors
                      typed_config:
                        "@type": type.googleapis.com/envoy.extensions.filters.http.cors.v3.Cors
                    - name: envoy.filters.http.router
                      typed_config:
                        "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
      clusters:
        - name: fivenet_service
          connect_timeout: 0.25s
          type: logical_dns
          http2_protocol_options: {}
          lb_policy: round_robin
          load_assignment:
            cluster_name: cluster_0
            endpoints:
              - lb_endpoints:
                - endpoint:
                    address:
                      socket_address:
                        address: '{{ include "fivenet.fullname" . }}'
                        port_value: 9090

# -- NATS server config values: https://artifacthub.io/packages/helm/nats/nats#values
nats:
  enabled: true
  config:
    cluster:
      enabled: true
      replicas: 3
    jetstream:
      enabled: true
      fileStore:
        enabled: true
        pvc:
          enabled: true
          size: 5Gi
          #storageClassName: default
      memoryStore:
        enabled: true
        # ensure that container has a sufficient memory limit greater than maxSize
        maxSize: 64Mi
    merge:
      accounts:
        fivenet:
          users:
            # You should change the username and password
            - user: "fivenet"
              password: "fivenet"
